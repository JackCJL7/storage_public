function getOs(){var t=navigator.userAgent.toLowerCase(),e=/iphone|ipod|ipad/.test(t),s=/android/.test(t);/safari/.test(t);return s?"android":e?"ios":"web"}function replaceTV(t){return t.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a").replace(/\ /g,"-").replace(/đ/g,"d").replace(/đ/g,"d").replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y").replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u").replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ.+/g,"o").replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ.+/g,"e").replace(/ì|í|ị|ỉ|ĩ/g,"i")}function showLoading(){$(".loading").css("display","block")}function hideLoading(){$(".loading").css("display","none")}$("textarea").each(function(){this.setAttribute("style","height:"+this.scrollHeight+"px;overflow-y:hidden;")}).on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"});var roundedPoly=function(t,e,s){function o(t,e,s){s.x=e.x-t.x,s.y=e.y-t.y,s.len=Math.sqrt(s.x*s.x+s.y*s.y),s.nx=s.x/s.len,s.ny=s.y/s.len,s.ang=Math.atan2(s.ny,s.nx)}for(var i,n,a,r,c,h,l,d={},u={},m=e.length,_=e[m-1],p=0;p<m;p++)i=e[p%m],n=e[(p+1)%m],o(i,_,d),o(i,n,u),c=d.nx*u.ny-d.ny*u.nx,l=d.nx*u.nx-d.ny*-u.ny,h=Math.asin(c),r=!(a=1),l<0?h<0?h=Math.PI+h:(h=Math.PI-h,a=-1,r=!0):0<h&&(a=-1,r=!0),c=h/2,h=(l=Math.abs(Math.cos(c)*s/Math.sin(c)))>Math.min(d.len/2,u.len/2)?(l=Math.min(d.len/2,u.len/2),Math.abs(l*Math.sin(c)/Math.cos(c))):s,c=i.x+u.nx*l,l=i.y+u.ny*l,c+=-u.ny*h*a,l+=u.nx*h*a,t.arc(c,l,h,d.ang+Math.PI/2*a,u.ang-Math.PI/2*a,r),_=i,0;t.closePath()};function drawArrowhead(t,e,s,o){var i,n=s.x,a=s.y;t.save(),t.fillStyle=t.strokeStyle,t.beginPath(),i=Math.atan2(s.y-e.y,s.x-e.x),s=o*Math.cos(i)+n,e=o*Math.sin(i)+a,t.moveTo(s,e),i+=1/3*(2*Math.PI),s=o*Math.cos(i)+n,e=o*Math.sin(i)+a,t.lineTo(s,e),i+=1/3*(2*Math.PI),s=o*Math.cos(i)+n,e=o*Math.sin(i)+a,t.lineTo(s,e),t.closePath(),t.fill(),t.restore()}function is_touch_device(){return"ontouchstart"in window||navigator.msMaxTouchPoints}function isDomVisile(t){return"none"!=$(t).css("display")}function dragMoveListener(t){var e=t.target,s=(parseFloat(e.getAttribute("data-x"))||0)+t.dx,t=(parseFloat(e.getAttribute("data-y"))||0)+t.dy;e.style.webkitTransform=e.style.transform="translate("+s+"px, "+t+"px)",e.setAttribute("data-x",s),e.setAttribute("data-y",t)}function initNote(t){mnote.addPages(t)}function exportJSON(){parent.postMessage({cmd:"MNoteJson",data:mnote.exportJSON()},"*")}function exportPdf(){MNote.getInstance().exportPdf()}function exportPdf_(){MNote.getInstance().exportPdf_()}function initPanZoom(t){var e=document.querySelector("#mnote_pages");panzoom(e,{beforeWheel:function(t){return!t.altKey},bounds:!0,boundsPadding:.05,maxZoom:3,minZoom:1,pinchSpeed:3,initialX:0,initialY:0,initialZoom:t})}window.addEventListener("message",function(t){t.data&&(t.data.cmd&&"initMNote"==t.data.cmd&&t.data.pages&&(mnote=MNote.getInstance(),mnote&&null==mnote.mnotedata&&mnote.initNote(t.data)),t.data.cmd&&"MNoteStaticText"==t.data.cmd&&(mnote=MNote.getInstance(),mnote.staticTextConfig=JSON.parse(t.data.data),localStorage&&localStorage.setItem("staticTextConfig",JSON.stringify(mnote.staticTextConfig))),t.data.cmd&&"getMNoteJson"==t.data.cmd&&parent.postMessage({cmd:"MNoteJson",data:mnote.exportJSON()},"*"))}),parent.postMessage("MNoteLoadComplete","*"),window.dragMoveListener=dragMoveListener,$(window).on("load",function(){});var MNote_instance=cc.Class.extend({appWidth:900,appHeight:1120,pageWidth:750,pageHeight:1120,pages:[],pageCount:0,pageScale:1,maxLineWidth:25,minLineWidth:1,maxTextSize:60,minTextSize:20,isDrawingMode:!1,currDrawStyle:null,currTextStyle:null,currBrush:"pen",lastTouchX:-1,lastTouchY:-1,lastTouchDown:!1,BRUSH_MOVE:"move",BRUSH_PEN:"pen",BRUSH_ERASE:"erase",BRUSH_TEXT:"text",BRUSH_POLYGON:"polygon",BRUSH_LINE:"line",BRUSH_RECTANGLE:"rangle",BRUSH_CIRCLE:"circle",BRUSH_ARROW:"arrow",canvasTouchStartX:-1,canvasTouchStartY:-1,canvasTouchStartTime:-1,canvasTapCount:0,aldreadyDelete:!1,mode:"mode_normal",MODE_NORMAL:"mode_normal",MODE_DRAWRING:"mode_drawing",MODE_ENTER_TEXT:"mode_enter_text",MODE_EDIT_TEXT:"mode_edit_text",countRight:0,countWrong:0,arrImg:[],mnotedata:null,staticTextConfig:null,desktopZoom:1,ctor:function(){var s=this;this.note_pages=document.getElementById("mnote_pages"),this.note_content=document.getElementById("mnote_content"),this.note_container=document.getElementById("mnote_container"),this.onresize(window.innerWidth,window.innerHeight),window.addEventListener("resize",()=>{this.onresize(window.innerWidth,window.innerHeight)}),is_touch_device()&&(this.panzoom=panzoom(this.note_container,{beforeWheel:function(t){return!t.altKey},onTouch:function(t){return"edit"!=s.mnotedata.mode},smoothScroll:!0,bounds:!0,boundsPadding:.5,maxZoom:4,minZoom:1}),this.panzoom.on("transform",t=>{var e;this.mode==this.MODE_NORMAL&&(e=document.getElementById("mnote_mark"),parseInt($(e).css("top"))>s.appHeight&&(e.getBoundingClientRect().top<s.appHeight||"edit"==s.mnotedata.mode&&$("#mnote_hold_bt").css("display","flex")))})),$("#mnote_help").css("display","block"),$(".help_text").css("float","left"),this.btnHoldDraw=document.getElementById("btn_hold_draw"),$(this.btnHoldDraw).on("touchend mouseup",t=>{this.setMode(this.MODE_DRAWRING),t.preventDefault()}),this.btnDrawFinish=document.getElementById("btn_draw_finish"),this.btnDrawErase=document.getElementById("btn_draw_erase"),this.btnDrawPen=document.getElementById("btn_draw_pen"),this.btnDrawColor=document.getElementById("btn_draw_color"),this.btnDrawText=document.getElementById("btn_draw_text"),this.btnDrawMove=document.getElementById("btn_draw_move"),$(this.btnDrawFinish).on("touchend mouseup",t=>{this.setMode(this.MODE_NORMAL),t.preventDefault()}),$(this.btnDrawErase).on("touchend mouseup",t=>{this.currBrush==this.BRUSH_ERASE?this.showMenuColor():this.setBrushDraw(this.BRUSH_ERASE)}),$(this.btnDrawText).on("touchend mouseup",t=>{this.setBrushDraw(this.BRUSH_TEXT),this.exportJSON()}),$(this.btnDrawMove).on("touchend mouseup",t=>{this.setBrushDraw(this.BRUSH_MOVE)}),$(this.btnDrawPen).on("touchend mouseup",t=>{this.currBrush==this.BRUSH_PEN||this.currBrush==this.BRUSH_LINE||this.currBrush==this.BRUSH_RECTANGLE||this.currBrush==this.BRUSH_CIRCLE||this.currBrush==this.BRUSH_ARROW?this.showMenuColor():this.setBrushDraw(this.BRUSH_PEN)}),this.mnote_menu_color=document.getElementById("mnote_menu_color"),this.menu_color_content=document.getElementById("menu_color_content"),$(this.mnote_menu_color).on("touchend mouseup",t=>{this.hideMenuColor(),t.stopPropagation()}),$(this.menu_color_content).on("touchend mouseup",t=>{t.stopPropagation()}),this.currDrawStyle={alpha:1,lineWidth:6,strokeStyle:"red",fillStyle:"red"},this.currTextStyle={font:"font_chu_dep",size:20,align:"left",color:"red",fill:!1},is_touch_device()?($("#mnote_app").css("overflow","hidden"),$("#mnote_content").css("overflow","hidden"),$("#bt_trash").css("left",window.innerWidth/2-30+"px"),$("#bt_trash").css("top","0px"),this.currDrawStyle.lineWidth=6):($("body").attr("spellcheck",!1),$("#mnote_content").css("overflow","scroll"),$("#menu_text_font").css("transform","scale(1)"),$("#bt_trash").css("left","0px"),$("#mnote_setting_zoom_out").css("display","block"),$("#mnote_setting_zoom_in").css("display","block"),$("#bt_trash").css("top",window.innerHeight/2+"px"),this.currDrawStyle.lineWidth=2,this.minTextSize=10),this.initMenuBottom(),this.initMenuText(),this.initMarkUI(),this.setBrushDraw(this.BRUSH_MOVE),this.contentBushPen=document.getElementById("content_brush_pen"),this.contentBushLine=document.getElementById("content_brush_line"),this.contentBushRect=document.getElementById("content_brush_rectangle"),this.contentBushCircle=document.getElementById("content_brush_circle"),this.contentBushArrow=document.getElementById("content_brush_arrow"),$(this.contentBushPen).on("touchend mouseup",t=>{this.setBrushDraw(this.BRUSH_PEN),t.preventDefault(),t.stopPropagation()}),$(this.contentBushLine).on("touchend mouseup",t=>{this.setBrushDraw(this.BRUSH_LINE),t.preventDefault(),t.stopPropagation()}),$(this.contentBushRect).on("touchend mouseup",t=>{this.setBrushDraw(this.BRUSH_RECTANGLE),t.preventDefault(),t.stopPropagation()}),$(this.contentBushCircle).on("touchend mouseup",t=>{this.setBrushDraw(this.BRUSH_CIRCLE),t.preventDefault(),t.stopPropagation()}),$(this.contentBushArrow).on("touchend mouseup",t=>{this.setBrushDraw(this.BRUSH_ARROW),t.preventDefault(),t.stopPropagation()}),this.thickSliderInput=document.getElementById("thick_slider_input"),$(this.thickSliderInput).on("input",t=>{this.setDrawStyle({lineWidth:parseInt($(this.thickSliderInput).val())})}),$(".btn-content-color").on("mouseup",function(t){s.setDrawStyle({strokeStyle:$(this).attr("data")}),t.preventDefault(),t.stopPropagation()});s=this;$("#thick_slider").on("touchstart",function(t){s.sliderThickTouch(t),t.preventDefault(),t.stopPropagation()}),$("#thick_slider").on("touchmove",function(t){s.sliderThickTouch(t),t.preventDefault(),t.stopPropagation()}),this.setDrawStyle(this.currDrawStyle),this.setTextStyle(this.currTextStyle),$("#color_content_close").on("touchend mouseup",()=>{this.hideMenuColor()}),$(".help_text").on("touchend mouseup",function(){$(this).css("display","none")}),window.addEventListener("mouseup",t=>{this.lastTouchDown=!1;var e=$(".obj_down");if(0<e.length&&this._endObj(e[0],t),$(".obj_down").removeClass("obj_down"),this.inactiveAllObj(),!is_touch_device())for(var s=0;s<this.pages.length;s++)this.onCanvasEnd(document.getElementById("canvas_"+s));document.getElementById("slider_text_size").isMouseDown=!1,$("#mnote_menu_edit_bg").css("display","none")}),window.addEventListener("mousemove",t=>{var e=$(".obj_down");0<e.length&&this._moveObj($(e[0]).get(0),t)}),window.addEventListener("mousedown",t=>{}),document.getElementById("capture").addEventListener("change",t=>{var e,s,o=document.getElementById("capture").files[0];o&&(e=this,(s=new FileReader).onload=function(t){e.addPage({backgroundImage:t.target.result})},s.readAsDataURL(o))}),$("#btn_save_data").on("touchstart mousedown",t=>{t.preventDefault()}),$("#btn_save_data").on("touchend mouseup",t=>{parent.postMessage({cmd:"MNoteJson",data:this.exportJSON()},"*"),t.preventDefault()}),$("#mnote_mark_result").on("touchstart mousedown",t=>{t.preventDefault()});var t=document.createElement("style");t.type="text/css",t.innerHTML="@font-face {font-family: handwriting_font_z;src: url(css/HP0015HB.ttf);}",document.getElementsByTagName("head")[0].appendChild(t),$("#mark_comment_txt").css("font-family","handwriting_font_z"),this.initStaticTextSetting(),$("#setting_menu_static_text").click(()=>{"none"==$("#setting_static_text").css("display")?this.showStaticTextSetting():this.hideStaticTextSetting()}),$("#setting_menu_mathtype").click(()=>{this.showMathEditor()});t=document.querySelectorAll(".dropdown-trigger"),M.Dropdown.init(t,{alignment:"bottom",hover:!1});this.initMathEditor(),$("#btn_resubmit").click(()=>{parent.postMessage({cmd:"MNoteReSubmit",data:{}},"*")}),$("#mnote_setting_zoom_out").click(()=>{this.setDesktopZoom(this.desktopZoom-.4)}),$("#mnote_setting_zoom_in").click(()=>{this.setDesktopZoom(this.desktopZoom+.4)}),$("#mnote_menu_edit_bg_rotate").click(t=>{$("#mnote_menu_edit_bg").css("display","none");var e=$("#mnote_menu_edit_bg").attr("data");this.rotateBgPage(e),t.preventDefault(),t.stopPropagation()}),$("#mnote_menu_edit_bg_moveup").click(t=>{$("#mnote_menu_edit_bg").css("display","none");var e=$("#mnote_menu_edit_bg").attr("data");this.moveUpPage(e),t.preventDefault(),t.stopPropagation()}),$("#mnote_menu_edit_bg_movedown").click(t=>{$("#mnote_menu_edit_bg").css("display","none");var e=$("#mnote_menu_edit_bg").attr("data");this.moveDownPage(e),t.preventDefault(),t.stopPropagation()})},sliderThickTouch:function(t){var e,s,o;t.touches.length<1||(s=t.touches[t.touches.length-1],e=(o=document.getElementById("thick_slider")).getBoundingClientRect(),s=1<(s=(s=(s.clientX-e.left)/e.width)<0?0:s)?1:s,$(this.thickSliderInput).val(Math.floor(2+33*s)),o=$(o).find(".thumb")[0],$(o).css("left",Math.floor(s*e.width-5)+"px"),this.setDrawStyle({lineWidth:parseInt($(this.thickSliderInput).val())}),t.preventDefault(),t.stopPropagation())},setDesktopZoom:function(t){.6<=t&&t<=8&&(this.desktopZoom=t,$("#mnote_container").css("transform","scale("+this.desktopZoom+")"))},initNote:function(t){this.mnotedata=t,this.mnotedata.fullname="hoten",this.mnotedata.classname="lop",this.mnotedata.homework="baitap",this.mnotedata.homeworkTime="0000_00_00",t.staticTextConfig&&(this.staticTextConfig=JSON.parse(t.staticTextConfig)),t.student_obj&&t.student_obj.fullName&&($("#mnote_user_name").html("Họ và tên : "+t.student_obj.fullName),this.mnotedata.fullname=replaceTV(t.student_obj.fullName)),t.classroom_obj&&t.classroom_obj.name&&($("#mnote_user_class").html("Lớp : "+t.classroom_obj.name),this.mnotedata.classname=replaceTV(t.classroom_obj.name)),t.homework_obj&&t.homework_obj.deadline&&(o=(o=t.homework_obj.deadline.split("T")[0]).split("-"),$("#mnote_user_time").html("Ngày "+o[2]+" tháng "+o[1]+" năm "+o[0]),this.mnotedata.homeworkTime=o[2]+"_"+o[1]+"_"+o[0]),t.homework_obj&&t.homework_obj.content&&($("#mnote_user_homework").html(t.homework_obj.content),this.mnotedata.homework=replaceTV(t.homework_obj.name.substr(0,50)));for(var e=0;e<t.pages.length;e++)null==t.pages[e].id&&(t.pages[e].id=e);if(this.addPages(t.pages),t.comment&&$("#mark_comment_txt").val(t.comment),t.point&&$("#mark_number_txt").val(t.point),this.resizeTxtComment(),t.commentEmoji&&this.addCommentEmoji(t.commentEmoji),"edit"==this.mnotedata.mode){var s=!1;if(null!=this.mnotedata.hideMark&&null!=this.mnotedata.hideMark)s=this.mnotedata.hideMark;else try{localStorage&&(s="true"==localStorage.getItem("hideMark"))}catch{}s?this.hideMark(!0):this.showMark(!0);try{"exam"==this.mnotedata.context&&$("#mnote_mark").css("display","none")}catch(t){}}else{is_touch_device()||($("#mark_comment_txt").attr("disabled",""),$("#mark_number_txt").attr("disabled","")),$("#mnote_mark_chose").css("display","none"),$("#btn_save_data").css("display","none"),$("#mnote_hold_bt").css("display","none"),$("#mnote_mark").css("top","0px"),$("#hide_mark").css("display","none"),$("#mnote_mark_hide").css("display","none");var o=$("#mnote_mark_point").height()-10;$("#mnote_pages").css("padding-top",o+"px"),$("#mnote_user_info").css("display","none"),$("#mnote_mark").on("touchend mousedown",t=>{}),$("#mnote_mark_result").css("display","none"),$("#mnote_setting_bt").css("display","none"),$("#mnote_setting_zoom_in").css("display","none"),$("#mnote_setting_zoom_out").css("display","none"),$("#mnote_mark_emoji_bt").css("display","none"),$("#mnote_help").css("display","none"),$("#mnote_mark_emoji_bt").css("display","none"),$(".bt-edit-bg").css("display","none"),1==this.mnotedata.hideMark&&this.hideMark()}setTimeout(()=>{"edit"==this.mnotedata.mode&&$("#mnote_hold_bt").css("display","flex")},500)},resetNote:function(){this.removeAllPage()},addPages:function(t){for(var e=0;e<t.length;e++)this.addPage(t[e])},addPage:function(t){var s=this,e="page_"+t.id,o=$('<div data="'+t.id+'" id="'+e+'" class="page"></div>');$(o).css("margin-top","5px"),$(this.note_pages).append($(o)),$(o).width(this.pageWidth-200);var i=$('<div class="page_bg"></div>');$(o).append($(i));var n=$('<div class="page_canvas_draw"></div>');$(o).append($(n));var a=$('<div class="page_objs_layer"></div>');$(o).append($(a)),$(a).css("pointer-events","none");var r=$('<i data="rotate" class="material-icons bt-edit-bg waves-effect waves-light" style="font-size:35px">crop_rotate</i>'),e=$('<i data="moveup" class="material-icons bt-edit-bg waves-effect waves-light" style="right:50px;font-size:35px">arrow_upward</i>');$(o).append($(r)),$(o).append($(e));a=document.createElement("canvas");a.id="canvas_"+t.id,a.index=t.id,a.pageid=t.id,a.style="position:absolute",$(a).addClass("canvas_draw"),this.addCanvasEventListener(a);r=document.createElement("canvas");r.id="canvasDraw_"+t.id,r.pageid=t.id,r.style="position:absolute",$(n).append(r),$(n).append(a);var c,h,o=!1,e=t.backgroundImage.length,n=t.backgroundImage.toLowerCase();if(n.indexOf(".mp4")>=e-5||n.indexOf(".mov")>=e-5||n.indexOf(".wmv")>=e-5||n.indexOf(".webm")>=e-5||n.indexOf(".mp3")>=e-5||n.indexOf(".m4a")>=e-5||0<=n.indexOf("player.vimeo")||0<=n.indexOf("mega.nz")?(o=!0,a.pagetype=1):a.pagetype=0,isNaN(t.width)||isNaN(t.height)||s.resizePage(t.id,t.width,t.height),t.backgroundImage?o?(0<=t.backgroundImage.indexOf("player.vimeo")||0<=t.backgroundImage.indexOf("mega.nz")?$(i).html('<iframe src="'+t.backgroundImage+'" width="100%" height=450 style="border:none"></iframe>'):t.backgroundImage.indexOf("wewiin.nyc3.cdn")<0?($(i).html('<video id="video_'+t.id+'" class="video-js vjs-big-play-centered" controls preload="auto" width="100%" height="450" style="width:100%;height:450px"><source src="'+t.backgroundImage+'" type="video/mp4" /></video>'),videojs("video_"+t.id,{controls:!0,autoplay:!1,preload:"auto"})):$(i).html(" Chức năng video đang tạm khoá , vui lòng thử lại sau ! "),s.resizePage(t.id,s.pageWidth,450,null),r.style.pointerEvents="none",a.style.pointerEvents="none",$(a.parentNode).css("pointer-events","none")):(c=new Image,$(i).append(c),this.arrImg.push(c),$(c).attr("pageid",t.id),$(c).attr("id","image_bg_"+t.id),$(c).attr("nl","1"),c.crossOrigin="anonymous",c.onload=function(){var t,e;$(this).parent()&&(id=parseInt($(this).attr("pageid")),t=s.pageWidth<c.width?s.pageWidth:c.width,e=Math.floor(c.height*t/c.width),c.width=t,c.height=e,s.resizePage(id,s.pageWidth,e,c))},c.onerror=function(){"1"==$(this).attr("nl")&&$(this).attr("src",$(this).attr("src")+"?time="+(new Date).getTime()),$(this).attr("nl","2")},c.src=t.backgroundImage):(i=4*(a=s.pageWidth)/3,s.resizePage(t.id,a,i,null)),t.draw&&(t.draw=t.draw.replaceAll("https://cdn.azota.vn/api/download_public","https://wewiin.nyc3.cdn.digitaloceanspaces.com"),h=new Image,$(c).attr("pageid",t.id),h.onload=function(t){var e=document.getElementById("canvas_"+parseInt($(c).attr("pageid")));e&&e.getContext("2d").drawImage(h,0,0)},h.crossOrigin="anonymous",h.src=t.draw),t.staticText&&0<t.staticText.length)for(var l=0;l<t.staticText.length;l++)this.addStaticText(t.id,t.staticText[l].value,t.staticText[l].x,t.staticText[l].y);if(t.objText&&0<t.objText.length)for(l=0;l<t.objText.length;l++)this._addText(t.id,t.objText[l].value,t.objText[l].x,t.objText[l].y,t.objText[l].textStyle);this.pageCount++,this.pages.push(t)},exportJSON:function(){var t={},h=[];t.pages=h;var e=$(".page"),l=this;$(e).each(function(t){var e={},s=$(this).find(".canvas_draw")[0];e.width=s.width,e.height=s.height,e.id=Number($(this).attr("data")),0==s.pagetype?(o=$(this).find("img")[0],e.backgroundImage=$(o).attr("src"),e.rotation=parseInt($(o).attr("rotation"))):e.backgroundImage=l.mnotedata.pages[s.pageid].backgroundImage;var o=$(this).find(".page_objs_layer")[0],i=$(o).find(".obj_static_text");e.staticText=[];for(var n=0;n<i.length;n++){var a={};a.x=parseInt($(i[n]).css("left")),a.y=parseInt($(i[n]).css("top")),$(i[n]).hasClass("wrong")?a.value="wrong":a.value="correct",e.staticText.push(a)}var r=$(o).find(".obj_text");e.objText=[];for(n=0;n<r.length;n++){var c={};c.x=parseInt($(r[n]).css("left")),c.y=parseInt($(r[n]).css("top")),c.value=$(r[n]).html(),c.textStyle=JSON.parse($(r[n]).attr("styleText").replaceAll("'",'"')),e.objText.push(c)}if(0==s.pagetype)try{e.draw=s.toDataURL("image/png")}catch(t){}h.push(e)}),t.staticTextConfig=JSON.stringify(this.staticTextConfig);try{localStorage.setItem("staticTextConfig",JSON.stringify(this.staticTextConfig))}catch(t){}t.comment=$("#mark_comment_txt").val(),t.commentEmoji=[];for(var s=$(".comment_emoji"),o=0;o<s.length;o++)t.commentEmoji.push($(s[o]).attr("src"));return t.point=$("#mark_number_txt").val(),t.point=t.point.replaceAll(",","."),null!=t.point&&null!=t.point&&""!=t.point&&!isNaN(Number(t.point))||(t.point=0),t.hideMark=this.mnotedata.hideMark,cc.log("EXPORT JSON "+JSON.stringify(t)),t},updateSaveImageSuccess:function(t,e){},updateSaveImage:function(t){},updateAllImage:function(){},removeAllPage:function(t){this.pageCount=0,this.pages=[],$("mnote_pages").empty()},removePage:function(t){},moveUpPage:function(t){for(var e,s,o=document.getElementById("mnote_pages"),i=o.childNodes,n=-1,a=0;a<i.length;a++)i[a].id=="page_"+t&&(n=a);1<n&&(e=i[n-1],s=i[n],$(e).hasClass("page")&&o.insertBefore(s,e))},moveDownPage:function(t){for(var e,s,o=document.getElementById("mnote_pages"),i=o.childNodes,n=-1,a=0;a<i.length;a++)i[a].id=="page_"+t&&(n=a);n<i.length-1&&(e=i[n+1],s=i[n],$(e).hasClass("page")&&o.insertBefore(e,s))},resizePage:function(s,t,e,o){var i=$("#page_"+s);$("#page_"+s).css("width",t+"px"),$("#page_"+s).css("height",e+"px");var n,a=document.getElementById("canvas_"+s),r=document.getElementById("canvasDraw_"+s);1!=a.isUpdateSize&&(a.width=t,a.height=e,r.width=t,r.height=e,a.isUpdateSize=!0),Math.floor(a.height)!=Math.floor(e)&&(a.width=t,a.height=e,r.width=t,r.height=e,this.mnotedata.pages[s].draw&&(l=(l=this.mnotedata.pages[s].draw).replaceAll("https://cdn.azota.vn/api/download_public","https://wewiin.nyc3.cdn.digitaloceanspaces.com"),(n=new Image).onload=function(t){var e=document.getElementById("canvas_"+s);e&&e.getContext("2d").drawImage(n,0,0)},n.crossOrigin="anonymous",n.src=l)),"edit"==this.mnotedata.mode&&$("#mnote_mark").css("top",$(this.note_pages).height()+40+"px"),$(this.note_container).height($(this.note_pages).height()*this.pageScale+1.5*window.innerHeight),"edit"==this.mnotedata.mode&&"web"==getOs()&&$(this.note_container).height($(this.note_container).height()+300);for(var c=null,h=0;h<this.mnotedata.pages.length;h++)this.mnotedata.pages[h].id==s&&(c=this.mnotedata.pages[h]);var l=0;c&&(l=isNaN(Number(c.rotation))?0:Number(c.rotation));var d,i=$(i).find(".bt-edit-bg");$(i).css("display","none"),null!=o&&($(o).attr("imgwidth",t),$(o).attr("imgheight",e),$(o).attr("rotation",l),this.rotateBgImage(o,l),"edit"==this.mnotedata.mode&&$(i).css("display","block"),d=this,$(i).on("touchend mouseup",function(t){"rotate"==$(this).attr("data")?d.rotateBgPage(Number($(this).parent().attr("data"))):d.moveUpPage(Number($(this).parent().attr("data"))),t.preventDefault(),t.stopPropagation()}))},rotateBgPage:function(t){var e=document.getElementById("image_bg_"+t),t=parseInt($(e).attr("rotation"));(t-=90)<=-360&&(t=0),this.rotateBgImage(e,t)},rotateBgImage:function(t,e){var s,o=parseInt($(t).attr("imgwidth")),i=parseInt($(t).attr("imgheight"));$(t).css("transform","rotate("+e+"deg)"),$(t).attr("rotation",e),-90==e||-270==e?o<i?(s=i/o,t.height=o,t.width=Math.floor(o/s)):(s=o/i,t.width=i,t.height=Math.floor(i/s)):(t.width=o,t.height=i)},addCanvasEventListener:function(t){"edit"==this.mnotedata.mode&&(is_touch_device()?(t.addEventListener("touchstart",t=>{this.onCanvasTouchStart(t)}),t.addEventListener("touchmove",t=>{this.onCanvasTouchMove(t)},!1),t.addEventListener("touchend",t=>{this.onCanvasTouchEnd(t)})):(t.addEventListener("mousedown",t=>{this.onCanvasTouchStart(t)}),t.addEventListener("mousemove",t=>{this.onCanvasTouchMove(t)},!1)))},onCanvasTouchStart:function(t){cc.log("touch start");var e=t.currentTarget,s=this.getCoorTouchEvent(e,t);if(e.downing=!0,e.downx=s.x,e.downy=s.y,e.downclientx=s.clientX,e.downclienty=s.clientY,e.lastmoveclientx=s.clientX,e.lastmoveclienty=s.clientY,e.lastmovex=s.x,e.lastmovey=s.y,e.lastmovex1=s.x,e.lastmovey1=s.y,e.downtime=(new Date).getTime(),e.movefar=!1,this.mode!=this.MODE_NORMAL){if(this.mode==this.MODE_DRAWRING){s=e.getContext("2d");return s.moveTo(e.lastmovex,e.lastmovey),s.beginPath(),this.currBrush!=this.BRUSH_MOVE&&this.currBrush!=this.BRUSH_TEXT&&($(".obj_text").css("pointer-events","none"),$(".obj_static_text").css("pointer-events","none")),void t.preventDefault()}(this.mode==this.MODE_ENTER_TEXT||this.mode==this.MODE_EDIT_TEXT)&&t.preventDefault()}else t.preventDefault()},onCanvasTouchMove:function(t){var e=t.currentTarget,s=document.getElementById("canvasDraw_"+e.pageid),o=this.getCoorTouchEvent(e,t);if(e.downing&&(30<Math.abs(o.x-e.downx)||30<Math.abs(o.y-e.downy))&&(e.movefar=!0),this.mode==this.MODE_NORMAL)return e.lastmovex=o.x,e.lastmovey=o.y,e.lastmoveclientx=o.clientX,void(e.lastmoveclienty=o.clientY);if(this.mode==this.MODE_DRAWRING){var i,n,a,r=!1;return t.touches&&1<t.touches.length&&(r=!0),void(this.currBrush!=this.BRUSH_MOVE&&this.currBrush!=this.BRUSH_TEXT&&e.downing&&!r&&(1<Math.abs(o.x-e.lastmovex)||1<Math.abs(o.y-e.lastmovey))&&(ctx=(this.currBrush==this.BRUSH_PEN||this.currBrush==this.BRUSH_ERASE?e:s).getContext("2d"),ctx.lineCap="round",ctx.lineJoin="round",ctx.strokeMiterLimit=1,ctx.globalAlpha=this.currDrawStyle.alpha,ctx.strokeStyle=this.currDrawStyle.strokeStyle,ctx.lineWidth=this.currDrawStyle.lineWidth,this.currBrush==this.BRUSH_PEN&&(ctx.globalCompositeOperation="source-over"),this.currBrush==this.BRUSH_ERASE&&(ctx.globalCompositeOperation="destination-out",ctx.lineWidth=10*this.currDrawStyle.lineWidth,ctx.lineWidth=ctx.lineWidth<30?30:ctx.lineWidth),this.currBrush==this.BRUSH_PEN||this.currBrush==this.BRUSH_ERASE?(ctx.beginPath(),is_touch_device()?(ctx.moveTo(e.lastmovex1,e.lastmovey1),ctx.lineTo(o.x,o.y)):(ctx.moveTo(e.lastmovex,e.lastmovey),i=(e.lastmovex1+o.x)/2,n=(e.lastmovey1+o.y)/2,ctx.quadraticCurveTo(e.lastmovex1,e.lastmovey1,i,n)),ctx.stroke()):(ctx.clearRect(0,0,e.width,e.height),this.currBrush==this.BRUSH_LINE&&(ctx.beginPath(),ctx.moveTo(e.downx,e.downy),ctx.lineTo(o.x,o.y),ctx.stroke()),this.currBrush==this.BRUSH_RECTANGLE&&(ctx.beginPath(),s=Math.min(e.downx,o.x),a=Math.min(e.downy,o.y),i=Math.max(e.downx,o.x),n=Math.max(e.downy,o.y),ctx.rect(s,a,i-s,n-a),ctx.stroke()),this.currBrush==this.BRUSH_CIRCLE&&(ctx.beginPath(),a=Math.floor(Math.sqrt((e.downx-o.x)*(e.downx-o.x)+(e.downy-o.y)*(e.downy-o.y))),ctx.arc(e.downx,e.downy,a,0,2*Math.PI),ctx.stroke()),this.currBrush==this.BRUSH_ARROW&&(ctx.beginPath(),ctx.moveTo(e.downx,e.downy),ctx.lineTo(o.x,o.y),ctx.stroke(),drawArrowhead(ctx,{x:e.downx,y:e.downy},{x:o.x,y:o.y},3*ctx.lineWidth))),e.lastmovex=e.lastmovex1,e.lastmovey=e.lastmovey1,e.lastmovex1=o.x,e.lastmovey1=o.y,e.lastmoveclientx=o.clientX,e.lastmoveclienty=o.clientY))}if(this.mode==this.MODE_ENTER_TEXT)return e.lastmovex=o.x,e.lastmovey=o.y,e.lastmoveclientx=o.clientX,e.lastmoveclienty=o.clientY,void t.preventDefault();this.mode==this.MODE_EDIT_TEXT&&t.preventDefault()},onCanvasTouchEnd:function(t){cc.log("touch end");var e=t.currentTarget;return this.mode==this.MODE_NORMAL||this.mode==this.MODE_DRAWRING?(this.onCanvasEnd(e),void t.preventDefault()):this.mode==this.MODE_ENTER_TEXT?(this.onCanvasEnd(e),t.preventDefault(),void t.stopPropagation()):void(this.mode==this.MODE_EDIT_TEXT&&(this.onCanvasEnd(e),t.preventDefault()))},onCanvasEnd:function(t){var e,s,o,i,n,a,r,c=(new Date).getTime();t.downing&&(cc.log("onCanvasEnd "+t.lastmovex+":"+t.downx+":"+t.lastmovey+":"+t.downy+":"+this.mode+":"+this.currBrush),cc.log("onCanvasEnd "+t.lastmoveclientx+":"+t.downclientx+":"+t.lastmoveclienty+":"+t.downclienty+":"+this.mode+":"+this.currBrush),a=!0,(o=this.mode)==this.MODE_ENTER_TEXT&&(is_touch_device()?this.checkIsTouchTapCanvas(t)&&(this.blurText(),this.setMode(this.MODE_DRAWRING),this.setBrushDraw(this.BRUSH_MOVE)):(this.blurText(),this.setMode(this.MODE_DRAWRING)),a=!1),o==this.MODE_DRAWRING&&(this.currBrush==this.BRUSH_TEXT&&(is_touch_device()&&!this.checkIsTouchTapCanvas(t)||this.addText(t.index,t.lastmovex,t.lastmovey),a=!1),this.currBrush==this.BRUSH_ERASE&&(a=!1),this.currBrush==this.BRUSH_PEN&&(a=!1),i=document.getElementById("canvasDraw_"+t.pageid),e=t.getContext("2d"),i.getContext("2d").clearRect(0,0,t.width,t.height),e.lineCap="round",e.lineJoin="round",e.strokeMiterLimit=10,e.shadowColor="rgba(0,0,0,.5)",e.globalAlpha=this.currDrawStyle.alpha,e.strokeStyle=this.currDrawStyle.strokeStyle,e.lineWidth=this.currDrawStyle.lineWidth,e.globalCompositeOperation="source-over",this.currBrush==this.BRUSH_LINE&&(e.beginPath(),e.moveTo(t.downx,t.downy),e.lineTo(t.lastmovex1,t.lastmovey1),e.stroke(),a=!1),this.currBrush==this.BRUSH_RECTANGLE&&(e.beginPath(),s=Math.min(t.downx,t.lastmovex1),n=Math.min(t.downy,t.lastmovey1),o=Math.max(t.downx,t.lastmovex1),i=Math.max(t.downy,t.lastmovey1),e.rect(s,n,o-s,i-n),e.stroke(),a=!1),this.currBrush==this.BRUSH_CIRCLE&&(e.beginPath(),n=Math.floor(Math.sqrt((t.downx-t.lastmovex1)*(t.downx-t.lastmovex1)+(t.downy-t.lastmovey1)*(t.downy-t.lastmovey1))),e.arc(t.downx,t.downy,n,0,2*Math.PI),e.stroke()),this.currBrush==this.BRUSH_ARROW&&(e.beginPath(),e.moveTo(t.downx,t.downy),e.lineTo(t.lastmovex1,t.lastmovey1),e.stroke(),drawArrowhead(e,{x:t.downx,y:t.downy},{x:t.lastmovex1,y:t.lastmovey1},3*e.lineWidth)),$(".obj_text").css("pointer-events","all"),$(".obj_static_text").css("pointer-events","all")),a&&(a=!1,(!is_touch_device()||c-t.downtime<150&&0<t.downy&&0<t.downx&&0<t.lastmovex&&0<t.lastmovey&&Math.abs(t.lastmoveclientx-t.downclientx)<13&&Math.abs(t.lastmoveclienty-t.downclienty)<13)&&(a=!0),a?null!=t.endtime&&c-t.endtime<200?(t.tapCount++,cc.log(t.tapCount+" multi click canvas "+t.index+":"+t.endx+":"+t.endy),2==t.tapCount&&this.doubleClickCanvas(t)):t.tapCount=1:t.tapCount=0,1==t.tapCount&&(r=t,setTimeout(()=>{1==r.tapCount&&this.clickCanvas(r)},200))),t.endtime=c,t.endx=t.lastmovex,t.endy=t.lastmovey,t.endmovefar=t.movefar,t.downing=!1,t.downx=-1,t.downy=-1,t.lastmovex=-1,t.lastmovey=-1,t.downtime=0,t.movefar=!1)},checkIsTouchTapCanvas:function(t){return(new Date).getTime()-t.downtime<150&&0<t.downy&&0<t.downx&&0<t.lastmovex&&0<t.lastmovey&&Math.abs(t.lastmoveclientx-t.downclientx)<13&&Math.abs(t.lastmoveclienty-t.downclienty)<13},clickCanvas:function(t){cc.log("click canvas "+t.index+":"+t.endx+":"+t.endy+":"+this.staticTextConfig.correctWidth/2),this.mode==this.MODE_NORMAL&&this.addStaticText(t.index,"correct",t.endx-30,t.endy-this.staticTextConfig.correctHeight/2),this.mode==this.MODE_DRAWRING&&(this.currBrush==this.BRUSH_TEXT||t.endmovefar||this.addStaticText(t.index,"correct",t.endx-30,t.endy-this.staticTextConfig.correctHeight/2))},doubleClickCanvas:function(t){cc.log("double click canvas "+t.index+":"+t.endx+":"+t.endy),this.mode==this.MODE_NORMAL&&this.addStaticText(t.index,"wrong",t.endx-30,t.endy-this.staticTextConfig.wrongHeight/2),this.mode==this.MODE_DRAWRING&&(this.currBrush==this.BRUSH_TEXT||t.endmovefar||this.addStaticText(t.index,"wrong",t.endx-30,t.endy-this.staticTextConfig.wrongHeight/2))},getCoorTouchCanvas:function(t,e){var s=e.clientX,o=e.clientY,e=t.getBoundingClientRect();return{x:Math.floor((s-e.left)*($(t).width()/e.width)),y:Math.floor((o-e.top)*($(t).height()/e.height))}},getCoorTouchEvent:function(t,e){if(e.touches){if(e.touches.length<1)return{x:0,y:0};var s=e.touches[e.touches.length-1],o=s.clientX,i=s.clientY,s=t.getBoundingClientRect();return{clientX:o,clientY:i,x:Math.floor((o-s.left)*($(t).width()/s.width)),y:Math.floor((i-s.top)*($(t).height()/s.height))}}o=e.clientX,i=e.clientY,s=t.getBoundingClientRect();return{clientX:o,clientY:i,x:Math.floor((o-s.left)*($(t).width()/s.width)),y:Math.floor((i-s.top)*($(t).height()/s.height))}},getCoorTouch:function(t){var e,t=t.touches&&1==t.touches.length?(e=t.touches[t.touches.length-1].clientX,t.touches[t.touches.length-1].clientY):(e=t.clientX,t.clientY);return{clientX:e,clientY:t,x:e,y:t}},showMenuNormal:function(){$("#mnote_hold_bt").css("display","flex"),$("#mnote_setting_bt").css("display","block"),$("#mnote_help").css("display","block"),$(".help_text").css("display","block")},hideMenuNormal:function(){$("#mnote_hold_bt").css("display","none"),$("#mnote_setting_bt").css("display","none"),$(".help_text").css("display","none")},setMode:function(t){t!=this.mode&&(this.hideMenuDraw(),this.hideMenuText(),this.hideMenuNormal(),t==this.MODE_NORMAL&&(this.showMenuNormal(),this.blurText(),is_touch_device()||$("#mnote_pages").css("cursor","default")),t==this.MODE_ENTER_TEXT&&this.showMenuText(),t==this.MODE_DRAWRING&&this.showMenuDraw(),this.mode=t)},enterDrawingMode:function(){this.isDrawingMode=!0,this.mode=this.MODE_DRAWRING,this.showMenuDraw()},exitDrawingMode:function(){this.isDrawingMode=!1,this.mode=this.MODE_NORMAL,$(".help_text").css("display","block"),this.hideMenuDraw(),$("#mnote_hold_bt").css("display","flex")},showMenuDraw:function(){is_touch_device()?$("#mnote_menu_bottom").css("display","block"):($("#mnote_menu_draw").find("span").first(),$("#mnote_menu_draw").css("display","flex"),gsap.fromTo(".btn-menu-draw",{scale:1},{scale:1,duration:.1,ease:"expo.out"})),this.currBrush==this.BRUSH_TEXT&&this.setBrushDraw(this.BRUSH_MOVE)},hideMenuDraw:function(){is_touch_device()?$("#mnote_menu_bottom").css("display","none"):(clearInterval(this.ivtInvisibleSpanMenuDraw),$("#mnote_menu_draw").css("display","none"))},setBrushDraw:function(t){this.currBrush=t,is_touch_device()||(t==this.BRUSH_PEN||t==this.BRUSH_LINE||t==this.BRUSH_RECTANGLE||t==this.BRUSH_CIRCLE||t==this.BRUSH_ARROW?$("#mnote_pages").css("cursor","url('images/pen.png') 0 20, auto"):t==this.BRUSH_ERASE?$("#mnote_pages").css("cursor","url('images/erase.png') 0 20, auto"):t==this.BRUSH_TEXT?$("#mnote_pages").css("cursor","url('images/text.png') 0 20, auto"):$("#mnote_pages").css("cursor","default")),this.setDrawStyle(this.currDrawStyle)},showMenuColor:function(){$(this.mnote_menu_color).css("display","block"),gsap.fromTo(this.menu_color_content,{scale:.1},{scale:1,duration:.15,ease:"expo.out"})},hideMenuColor:function(){$(this.mnote_menu_color).css("display","none")},setDrawStyle:function(t){this.currDrawStyle.strokeStyle;cc.log("setDrawStyle "+JSON.stringify(t)),t.lineWidth&&(this.currDrawStyle.lineWidth=t.lineWidth),t.strokeStyle&&(this.currDrawStyle.strokeStyle=t.strokeStyle),t.alpha&&(this.currDrawStyle.alpha=t.alpha),cc.log("setDrawStyle "+JSON.stringify(this.currDrawStyle)+":"+this.currBrush),$("#btn_thick_preview").css("opacity",this.currDrawStyle.alpha);var e=this;$(".btn-content-color").each(function(t){$(this).empty(),$(this).attr("data")==e.currDrawStyle.strokeStyle&&$(this).append($('<i class="material-icons">check</i>'))}),$("#btn_draw_color").find("svg").css("fill",this.currDrawStyle.strokeStyle),$("#btn_thick_preview").css("background-color",this.currDrawStyle.strokeStyle),$(this.thickSliderInput).val(this.currDrawStyle.lineWidth),$("#btn_thick_preview").css("width",this.currDrawStyle.lineWidth+5+"px"),$("#btn_thick_preview").css("height",this.currDrawStyle.lineWidth+5+"px"),this.setActiveButton(this.btnDrawPen,!1),this.setActiveButton(this.btnDrawErase,!1),this.setActiveButton(this.btnDrawText,!1),this.setActiveButton(this.btnDrawMove,!1),this.setActiveButton(this.contentBushPen,!1),this.setActiveButton(this.contentBushLine,!1),this.setActiveButton(this.contentBushRect,!1),this.setActiveButton(this.contentBushCircle,!1),this.setActiveButton(this.contentBushArrow,!1),$(".btn-option-draw").css("background-color","black"),$(".btn-option-draw").find("svg").css("fill","#888888"),$(".btn-option-draw").find("svg").css("color","#888888"),$(".btn-option-draw").find("i").css("color","#888888"),$("#option_brush").css("display","none"),this.currBrush==this.BRUSH_PEN&&(this.setActiveButton(this.btnDrawPen,!0,this.currDrawStyle.strokeStyle),this.setActiveButton(this.contentBushPen,!0,this.currDrawStyle.strokeStyle),$("#btn_option_pen").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_pen").find("svg").css("fill","white"),$("#btn_option_pen").find("i").css("color","white"),$("#option_brush").css("display","block"),$("#btn_option_brush_pen").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_brush_pen").find("svg").css("fill","white"),$("#btn_option_brush_pen").find("svg").css("color","white"),$("#btn_option_brush_pen").find("i").css("color","white")),this.currBrush==this.BRUSH_LINE&&(this.setActiveButton(this.btnDrawPen,!0,this.currDrawStyle.strokeStyle),this.setActiveButton(this.contentBushLine,!0,this.currDrawStyle.strokeStyle),$("#btn_option_pen").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_pen").find("svg").css("fill","white"),$("#btn_option_pen").find("i").css("color","white"),$("#option_brush").css("display","block"),$("#btn_option_brush_line").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_brush_line").find("svg").css("fill","white"),$("#btn_option_brush_line").find("svg").css("color","white"),$("#btn_option_brush_line").find("i").css("color","white")),this.currBrush==this.BRUSH_RECTANGLE&&(this.setActiveButton(this.btnDrawPen,!0,this.currDrawStyle.strokeStyle),this.setActiveButton(this.contentBushRect,!0,this.currDrawStyle.strokeStyle),$("#btn_option_pen").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_pen").find("svg").css("fill","white"),$("#btn_option_pen").find("i").css("color","white"),$("#option_brush").css("display","block"),$("#btn_option_brush_rect").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_brush_rect").find("svg").css("fill","white"),$("#btn_option_brush_rect").find("svg").css("color","white"),$("#btn_option_brush_rect").find("i").css("color","white")),this.currBrush==this.BRUSH_CIRCLE&&(this.setActiveButton(this.btnDrawPen,!0,this.currDrawStyle.strokeStyle),this.setActiveButton(this.contentBushCircle,!0,this.currDrawStyle.strokeStyle),$("#btn_option_pen").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_pen").find("svg").css("fill","white"),$("#btn_option_pen").find("i").css("color","white"),$("#option_brush").css("display","block"),$("#btn_option_brush_circle").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_brush_circle").find("svg").css("fill","white"),$("#btn_option_brush_circle").find("svg").css("color","white"),$("#btn_option_brush_circle").find("i").css("color","white")),this.currBrush==this.BRUSH_ARROW&&(this.setActiveButton(this.btnDrawPen,!0,this.currDrawStyle.strokeStyle),this.setActiveButton(this.contentBushArrow,!0,this.currDrawStyle.strokeStyle),$("#btn_option_pen").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_pen").find("svg").css("fill","white"),$("#btn_option_pen").find("i").css("color","white"),$("#option_brush").css("display","block"),$("#btn_option_brush_arrow").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_brush_arrow").find("svg").css("fill","white"),$("#btn_option_brush_arrow").find("svg").css("color","white"),$("#btn_option_brush_arrow").find("i").css("color","white")),this.currBrush==this.BRUSH_ERASE&&(this.setActiveButton(this.btnDrawErase,!0,this.currDrawStyle.strokeStyle),$("#btn_option_erase").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_erase").find("svg").css("fill","white"),$("#btn_option_erase").find("i").css("color","white")),this.currBrush==this.BRUSH_TEXT&&(this.setActiveButton(this.btnDrawText,!0,this.currDrawStyle.strokeStyle),$("#btn_option_text").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_text").find("svg").css("fill","white"),$("#btn_option_text").find("i").css("color","white")),this.currBrush==this.BRUSH_MOVE&&(this.setActiveButton(this.btnDrawMove,!0,this.currDrawStyle.strokeStyle),$("#btn_option_move").css("background-color",this.currDrawStyle.strokeStyle),$("#btn_option_move").find("svg").css("fill","white"),$("#btn_option_move").find("i").css("color","white")),$("#thick_slider").find(".thumb").css("display","block"),$("#thick_slider").find(".thumb").css("opacity",.7),$("#thick_slider").find(".thumb").css("background-color",this.currDrawStyle.strokeStyle),$("#color_preview").css("background-color",this.currDrawStyle.strokeStyle),$("#color_preview").css("opacity",this.currDrawStyle.alpha),$("#color_preview").css("width",this.currDrawStyle.lineWidth+5+"px"),$("#color_preview").css("height",this.currDrawStyle.lineWidth+5+"px"),$("#btn_hold_draw").css("background-color",this.currDrawStyle.strokeStyle),$("#mnote_hold_bt").find("span").css("color",this.currDrawStyle.strokeStyle),$(this.btnDrawFinish).css("color",this.currDrawStyle.strokeStyle);t=this.currDrawStyle.lineWidth,this.canvas_slider.width,this.minLineWidth,this.maxLineWidth;$("#preview_draw_bt").css("width",3+t+"px"),$("#preview_draw_bt").css("height",3+t+"px"),$("#preview_draw_bt").css("background-color",this.currDrawStyle.strokeStyle);e=this;$(".btn-color-bottom-small").each(function(t){$(this).empty(),$(this).parent().css("border","none"),$(this).attr("data")==e.currDrawStyle.strokeStyle&&($(this).append($('<i class="material-icons">check</i>')),$(this).parent().css("border","solid 1px #CCCCCC"))})},setActiveButton:function(t,e,s){e?($(t).removeClass($(t).attr("activeColor")),$(t).addClass(s),$(t).find("svg").css("fill","white"),$(t).find("svg").css("color","white"),$(t).find("i").css("color","white"),$(t).attr("activeColor",s)):($(t).removeClass($(t).attr("activeColor")),$(t).addClass("white"),$(t).find("svg").css("fill","#666666"),$(t).find("svg").css("color","#666666"),$(t).find("i").css("color","#666666"),$(t).attr("activeColor","white"))},lastXStaticTextAdded:-1,lastYStaticTextAdded:-1,addStaticText:function(t,e,s,o){var i,n,a=document.getElementById("canvas_"+t).height,r=document.getElementById("canvas_"+t).width;s=Math.abs(s),o=Math.abs(o),s<0||o<0||r-40<s||a-40<o||Math.abs(s-this.lastXStaticTextAdded)<2&&Math.abs(o-this.lastYStaticTextAdded)<2||(r="","wrong"==e.toLowerCase()?this.staticTextConfig.useWrongText&&(r=this.staticTextConfig.textWrong):this.staticTextConfig.useCorrectText&&(r=this.staticTextConfig.textCorrect),a=$("<span pageid="+t+' class="obj_static_text"><span>'+r+"</span></span>"),r=$("#page_"+t).find(".page_objs_layer")[0],$(r).append(a),$(a).css("position","absolute"),$(a).attr("pageid",t),$(a).css("font-family",this.staticTextConfig.fontText),$(a).css("font-size",this.staticTextConfig.fontSize+"px"),$(a).css("text-align","center"),$(a).css("font-weight","bold"),$(a).css("min-width","50px"),$(a).css("min-height","50px"),$(a).css("text-shadow","1px 1px 1px #827e7e"),$(a).css("left",Math.floor(s)+"px"),$(a).css("top",Math.floor(o)+"px"),this.lastXStaticTextAdded=s,this.lastYStaticTextAdded=o,"wrong"==e.toLowerCase()?(this.countWrong++,$(a).addClass("wrong"),i=this.staticTextConfig.fontColor,n=$('<img class="wrong_img" src="'+this.staticTextConfig.urlImgWrong+'" width="30" height="30"/>'),$(a).append($(n)),this.staticTextConfig.useWrongText?($(n).css("display","none"),$(a).find("span").css("display","block")):($(n).css("display","block"),$(a).find("span").css("display","none"))):(this.countRight++,$(a).addClass("correct"),i=this.staticTextConfig.fontColor,n=$('<img class="correct_img" src="'+this.staticTextConfig.urlImgCorrect+'" width="30" height="30" />'),$(a).append($(n)),this.staticTextConfig.useCorrectText?($(n).css("display","none"),$(a).find("span").css("display","block")):($(n).css("display","block"),$(a).find("span").css("display","none"))),this.updateMark(),$(a).css("color",i),"edit"==this.mnotedata.mode&&$(a).css("pointer-events","all"),this.moveable(a))},moveable:function(s){var o;"edit"==this.mnotedata.mode&&(o=this,$(s).on("touchstart mousedown",function(t){var e;t.touches&&1<t.touches.length||(e=o.getCoorTouch(t),$(this).attr("downx",Math.floor(e.x)),$(this).attr("downy",Math.floor(e.y)),$(this).attr("clientx",Math.floor(e.clientX)),$(this).attr("clienty",Math.floor(e.clientY)),$(this).attr("lastx",Math.floor(e.x)),$(this).attr("lasty",Math.floor(e.y)),$(this).attr("downtime",(new Date).getTime()),$(".obj_down").removeClass("obj_down"),$(this).addClass("obj_down"),o.mode!=o.MODE_ENTER_TEXT&&($("#bt_trash").css("display","block"),$("#bt_trash").css("opacity",.7)),$(s).hasClass("obj_static_text")&&(t.preventDefault(),t.stopPropagation(),o.setObjsActive(this)))}),$(s).on("touchmove",function(t){t.touches&&1<t.touches.length||(o.getCoorTouch(t),o._moveObj(t.currentTarget,t),t.preventDefault(),t.stopPropagation())}),$(s).on("touchend mouseup",function(t){o._endObj(this,t),t.preventDefault(),t.stopPropagation()}))},_moveObj:function(t,e){var s,o,i;"true"==$(t).hasClass("obj_down").toString()&&(i=this.getCoorTouch(e),s=parseInt($(t).attr("downx")),o=parseInt($(t).attr("downy")),(5<Math.abs(i.x-s)||5<Math.abs(i.y-o))&&(e=this.getCoorTouchEvent(t.parentNode,e),$(t).css("left",Math.floor(e.x-$(t).width()/2)+"px"),$(t).css("top",Math.floor(e.y-$(t).height()/2)+"px")),$(t).attr("lastx",i.x),$(t).attr("lasty",i.y),(10<Math.abs(i.clientX-s)||10<Math.abs(i.clientY-o))&&$(t).attr("movefar",!0),$(t).attr("clientx",Math.floor(i.clientX)),$(t).attr("clienty",Math.floor(i.clientY)),i=parseInt($(t).attr("clientx")),t=parseInt($(t).attr("clienty")),i>self.appWidth/2-30&&i<self.appWidth/2+30&&t<70?$("#bt_trash").css("opacity",1):$("#bt_trash").css("opacity",.7))},_endObj:function(t,e){var s=this;if("true"==$(t).hasClass("obj_down").toString()){parseInt($(t).attr("downx")),parseInt($(t).attr("downy")),parseInt($(t).attr("lastx"));var o,i=parseInt($(t).attr("lasty")),n=parseInt($(t).attr("clientx")),a=parseInt($(t).attr("clienty"));if("true"!=$(t).attr("movefar")&&($(t).hasClass("obj_text")&&($(t).hasClass("focusing")||(s.focusText(t),e.preventDefault(),e.stopPropagation())),$(t).hasClass("obj_static_text")&&$(t).hasClass("correct")&&($(t).removeClass("correct"),$(t).addClass("wrong"),$(t).find("span").html(s.staticTextConfig.textWrong),0<(o=$(t).find("img")).length&&($(o[0]).attr("src",s.staticTextConfig.urlImgWrong),$(o[0]).removeClass("correct_img"),$(o[0]).addClass("wrong_img")),s.staticTextConfig.useWrongText?($(t).find("span").css("display","block"),$(t).find("img").css("display","none")):($(t).find("span").css("display","none"),$(t).find("img").css("display","block")),s.countRight--,s.countWrong++,s.updateMark())),$(t).attr("movefar",!1),$("#bt_trash").css("display","none"),cc.log("pos up "+n+":"+a+":"+s.appWidth+":"+s.appHeight/2+":"+i),is_touch_device()){if(n>s.appWidth/2-30&&n<s.appWidth/2+30&&a<70)return $(t).remove(),s.updateMark(),e.preventDefault(),void e.stopPropagation()}else if(0<n&&n<80&&a<s.appHeight/2+30&&a>s.appHeight/2-30)return $(t).remove(),s.updateMark(),e.preventDefault(),void e.stopPropagation();i=parseInt($(t).css("left")),n=parseInt($(t).css("top")),a=document.getElementById("canvas_"+parseInt($(t).attr("pageid"))).height;(i<0||n<0||i>s.pageWidth-40||a-40<n)&&($(t).remove(),s.updateMark(),e.preventDefault(),e.stopPropagation());n=parseInt($(t).attr("lastTouchTime"));if($(t).hasClass("obj_static_text")){var r=(new Date).getTime();if(!isNaN(n))if(r-n<(is_touch_device()?300:700))return $(t).hasClass("wrong")?s.countWrong--:s.countRight--,$(t).remove(),s.updateMark(),e.preventDefault(),void e.stopPropagation();s.inactiveAllObj()}$(t).attr("lastTouchTime",r),$(".obj_down").removeClass("obj_down")}},setObjsActive:function(t){this.inactiveAllObj(),$(t).addClass("obj_active"),$(t).css("border","2px dashed")},inactiveAllObj:function(){$(".obj_active").css("border","none"),$(".obj_active").removeClass("obj_active")},initMenuBottom:function(){var t=["green","red","purple","#3f51b5","teal","#03a9f4","yellow","#cddc39","cyan","#ffc107","#795548","#424242"];$("#menu_bottom_2_content").empty();for(var e=0;e<t.length;e++){var s=$('<div class="btn-color-bottom"><div data="'+t[e]+'" class="btn-color-bottom-small  btn-small btn-floating btn-flat waves-effect waves-light" style="background-color:'+t[e]+'"></div></div>');$("#menu_bottom_2_content").append($(s))}var o=this;$(".btn-color-bottom-small").click(function(t){o.setDrawStyle({strokeStyle:$(this).attr("data")})}),this.canvas_slider=document.getElementById("canvas_slider"),this.createCanvasSlider($("#menu_bottom_slider"),"#888888",this.minLineWidth,this.maxLineWidth,this.currDrawStyle.lineWidth),$(".btn-option-draw").click(function(t){var e=$(this).attr("data");"pen"==e&&o.setBrushDraw(o.BRUSH_PEN),"erase"==e&&o.setBrushDraw(o.BRUSH_ERASE),"move"==e&&o.setBrushDraw(o.BRUSH_MOVE),"text"==e&&o.setBrushDraw(o.BRUSH_TEXT),"line"==e&&o.setBrushDraw(o.BRUSH_LINE),"rect"==e&&o.setBrushDraw(o.BRUSH_RECTANGLE),"circle"==e&&o.setBrushDraw(o.BRUSH_CIRCLE),"arrow"==e&&o.setBrushDraw(o.BRUSH_ARROW)}),$("#menu_bottom_close").on("touchstart mouseup",t=>{o.setMode(o.MODE_NORMAL),t.stopPropagation(),t.preventDefault()}),$("#mnote_menu_bottom").on("touchstart",t=>{})},createCanvasSlider:function(e,t,s,o,i){var n,a,r=$(e).find("canvas");r.length<1||(n=r[0],(r=$(e).find(".thumb")).length<1||(a=r[0],(r=n.getContext("2d")).strokeStyle=t,r.lineWidth=4,n.min=s,n.max=o,r.fillStyle=t,r.moveTo(4,canvas_slider.height/2),r.beginPath(),r.lineCap="round",r.strokeMiterLimit=2,r.lineTo(n.width,Math.floor(n.height/2-5)),r.lineTo(n.width,Math.floor(n.height/2+5)),r.lineTo(4,n.height/2),r.closePath(),r.fill(),r.stroke(),this.setCanvasSliderValue(e,i),is_touch_device()?(n.addEventListener("touchstart",t=>{this._updateThumbSlider(e,t),t.stopPropagation(),t.preventDefault()}),n.addEventListener("touchmove",t=>{this._updateThumbSlider(e,t)}),$(a).on("touchstart",t=>{this._updateThumbSlider(e,t),t.stopPropagation(),t.preventDefault()}),$(a).on("touchmove",t=>{this._updateThumbSlider(e,t),t.stopPropagation(),t.preventDefault()})):(n.addEventListener("mousedown",t=>{n.isMouseDown=!0,this._updateThumbSlider(e,t),t.stopPropagation(),t.preventDefault()}),n.addEventListener("mousemove",t=>{1==n.isMouseDown&&this._updateThumbSlider(e,t)}),n.addEventListener("mouseup",t=>{n.isMouseDown=!1,$(a).attr("mousedown","false")}),$(a).css("pointer-events","none"))))},setCanvasSliderValue:function(t,e){var s,o,i=$(t).find("canvas");i.length<1||(s=i[0],(o=$(t).find(".thumb")).length<1||(i=o[0],e>s.max&&(e=max),e<s.min&&(e=min),o=3+20*(t=(e-s.min)/(s.max-s.min)),$(i).css("width",o+"px"),$(i).css("height",o+"px"),$(i).css("top",Math.floor(s.height-o)/2+"px"),$(i).css("left",Math.floor(s.width*t)-o/2+"px"),s.value=e,s==this.canvas_slider&&this.setDrawStyle({lineWidth:e}),s==this.slider_text_size&&this.setTextStyle({size:e})))},_updateThumbSlider:function(t,e){var s,o=$(t).find("canvas");o.length<1||(s=o[0],(o=is_touch_device()?e.touches[0]:{clientX:e.clientX})&&(e=s.getBoundingClientRect(),(e=o.clientX-e.left)<0&&(e=0),e>s.width&&(e=s.width),s=Math.floor(s.min+(s.max-s.min)*e/s.width),this.setCanvasSliderValue(t,s)))},initMenuText:function(){var t=["green","red","purple","#3f51b5","teal","#03a9f4","yellow","#cddc39","cyan","#ffc107","#795548","#424242"];$("#menu_text_color_content").empty();for(var e=0;e<t.length;e++){var s=$('<div class="btn-color-text"><div data="'+t[e]+'" class="btn-color-text-small  btn-small btn-floating btn-flat waves-effect waves-light" style="background-color:'+t[e]+'"></div></div>');$("#menu_text_color_content").append($(s))}this.slider_text_size=document.getElementById("slider_text_size"),this.createCanvasSlider("#menu_text_slider","black",this.minTextSize,this.maxTextSize,this.currTextStyle.size);var n=this;is_touch_device()?($(".btn-color-text-small").on("touchstart",function(t){1<t.touches.length||($(this).attr("downx",t.touches[0].clientX),$(this).attr("downy",t.touches[0].clientY),$(this).attr("movex",t.touches[0].clientX),$(this).attr("movey",t.touches[0].clientY))}),$(".btn-color-text-small").on("touchmove",function(t){1<t.touches.length||($(this).attr("movex",t.touches[0].clientX),$(this).attr("movey",t.touches[0].clientY))}),$(".btn-color-text-small").on("touchend",function(t){var e=parseInt($(this).attr("downx")),s=parseInt($(this).attr("downy")),o=parseInt($(this).attr("movex")),i=parseInt($(this).attr("movey"));Math.abs(e-o)<13&&Math.abs(s-i)<13&&n.setTextStyle({color:$(this).attr("data")}),t.stopPropagation(),t.preventDefault()}),$("#btn_option_align").on("touchend",function(t){"left"!=n.currTextStyle.align?"center"!=n.currTextStyle.align?"right"!=n.currTextStyle.align?(t.stopPropagation(),t.preventDefault()):n.setTextStyle({align:"left"}):n.setTextStyle({align:"right"}):n.setTextStyle({align:"center"})}),$("#btn_option_fill").on("touchend",function(t){n.currTextStyle.fill?n.setTextStyle({fill:!1}):n.setTextStyle({fill:!0}),t.stopPropagation(),t.preventDefault()}),$("#btn_option_font").on("touchend",function(t){isDomVisile(document.getElementById("menu_text_font"))?$("#menu_text_font").css("display","none"):$("#menu_text_font").css("display","block"),t.stopPropagation(),t.preventDefault()}),$(".font_chu").on("touchstart",function(t){n.setTextStyle({font:$(this).attr("data")}),t.stopPropagation(),t.preventDefault()}),$("#menu_text_option").on("touchstart mousedown",t=>{t.preventDefault()}),$("#mnote_menu_text").on("touchend mouseup",t=>{t.stopPropagation(),t.preventDefault()}),$("#menu_text_close").on("touchend",t=>{n.blurText(),n.setMode(n.MODE_DRAWRING),t.stopPropagation(),t.preventDefault()}),$("#btn_text_size").on("touchend",t=>{isDomVisile(document.getElementById("menu_text_slider"))?$("#menu_text_slider").css("display","none"):$("#menu_text_slider").css("display","flex"),t.stopPropagation(),t.preventDefault()}),$("#menu_text_color").on("touchstart",t=>{t.stopPropagation()})):($(".btn-color-text-small").on("mousedown",function(t){n.setTextStyle({color:$(this).attr("data")}),t.stopPropagation(),t.preventDefault()}),$("#btn_option_align").on("mousedown",function(t){t.stopPropagation(),t.preventDefault(),"left"!=n.currTextStyle.align?"center"!=n.currTextStyle.align?"right"==n.currTextStyle.align&&n.setTextStyle({align:"left"}):n.setTextStyle({align:"right"}):n.setTextStyle({align:"center"})}),$("#btn_option_fill").on("mousedown",function(t){n.currTextStyle.fill?n.setTextStyle({fill:!1}):n.setTextStyle({fill:!0}),t.stopPropagation(),t.preventDefault()}),$("#btn_text_size").on("mousedown",t=>{isDomVisile(document.getElementById("menu_text_slider"))?$("#menu_text_slider").css("display","none"):$("#menu_text_slider").css("display","flex"),t.stopPropagation(),t.preventDefault()}),$("#btn_option_font").on("mousedown",function(t){isDomVisile(document.getElementById("menu_text_font"))?$("#menu_text_font").css("display","none"):$("#menu_text_font").css("display","block"),t.stopPropagation(),t.preventDefault()}),$(".font_chu").on("mousedown",function(t){n.setTextStyle({font:$(this).attr("data")}),t.stopPropagation(),t.preventDefault()}),$("#menu_text_color").on("mousedown",t=>{t.stopPropagation()}),$("#menu_text_color").css("overflow-x","hidden"))},showMenuText:function(){$("#mnote_menu_text").css("display","block"),$("#mnote_setting_zoom_out").css("display","none"),$("#mnote_setting_zoom_in").css("display","none")},hideMenuText:function(){$("#mnote_menu_text").css("display","none"),$("#menu_text_slider").css("display","none"),$("#menu_text_font").css("display","none"),is_touch_device()||($("#mnote_setting_zoom_out").css("display","block"),$("#mnote_setting_zoom_in").css("display","block"))},_addText:function(t,e,s,o,i){var n=is_touch_device()?200:80;s=s+n>this.pageWidth?this.pageWidth-n:s;e=$('<div pageid="'+t+'" class="obj_text" style="padding:10px" contenteditable="true">'+e+"</div>"),t=$("#page_"+t).find(".page_objs_layer")[0];$(t).append(e),$(e).css("position","absolute"),$(e).css("font-family",i.font),$(e).css("text-align",i.align),$(e).css("left",s+"px"),$(e).css("top",o+"px"),$(e).css("min-width",n+"px"),$(e).css("letter-spacing","3px"),$(e).css("font-size",i.size+"px"),$(e).css("font-weight","bold"),i.fill?($(e).css("color","white"),$(e).css("background-color",i.color)):($(e).css("color",i.color),$(e).css("background-color","tranparent")),"edit"==this.mnotedata.mode&&$(e).css("pointer-events","all"),$(e).css("border-radius","8px"),$(e).attr("styleText",JSON.stringify(i).replaceAll('"',"'"));var a=this;return $(e).blur(function(){cc.log("on text lost focus"),$(this).removeClass("focusing"),$(this).css("border","none"),""==$(this).html().trim()&&$(this).remove(),a.setMode(a.MODE_DRAWRING)}),$(e).focus(function(t){cc.log("on text focus"),$(this).addClass("focusing"),$(this).css("border","dashed 2px"),a.setTextStyle(JSON.parse($(this).attr("styleText").replaceAll("'",'"'))),a.setMode(a.MODE_ENTER_TEXT)}),$(e).on("input",function(t){var e=parseInt($(this).css("left"));e+$(this).width()>a.pageWidth-15&&(e=a.pageWidth-$(this).width()-15,$(this).css("left",e+"px"))}),this.moveable(e),$(e)},addText:function(t,e,s){s=this._addText(t,"",e,s,this.currTextStyle);this.focusText($(s)),this.setMode(this.MODE_ENTER_TEXT)},focusText:function(t){this.blurText(),$(".focusing").removeClass("focusing"),$(t).focus();var e=$(t).get(0).getBoundingClientRect(),s=0;e.top>this.appHeight/4-50&&(s=e.top-(this.appHeight/4-50)),this.panzoom&&"android"==getOs()&&this.panzoom.moveBy(0,-s);var o,i,e=$(t).get(0);""!=$(t).html()&&(s=document.createRange(),t=window.getSelection(),null!=e.childNodes?(3==(i=e.childNodes[e.childNodes.length-1]).nodeType&&(o=i.length,s.setStart(i,o)),1==i.nodeType&&(o=i.firstChild.length,s.setStart(i.firstChild,o))):(i=e.firstChild,s.setStart(i,i.length)),s.collapse(!0),t.removeAllRanges(),t.addRange(s))},blurText:function(){$(".focusing").blur(),$(".focusing").each(function(t){$(this).removeClass("focusing"),$(this).css("border","none"),""==$(this).html().trim()&&$(this).remove()})},setTextStyle:function(t){t.font&&(this.currTextStyle.font=t.font),t.color&&(this.currTextStyle.color=t.color),t.size&&(this.currTextStyle.size=t.size),null!=t.fill&&(this.currTextStyle.fill=t.fill),t.align&&(this.currTextStyle.align=t.align);t=this.currTextStyle.size;$("#btn_text_size").find("span").html(t),$("#slider_text_thumb").css("background-color",this.currTextStyle.color);var e=this;$(".btn-color-text-small").each(function(t){$(this).empty(),$(this).parent().css("border","none"),$(this).attr("data")==e.currTextStyle.color&&($(this).append($('<i class="material-icons">check</i>')),$(this).parent().css("border","solid 1px #CCCCCC"))}),"left"==this.currTextStyle.align&&$("#btn_option_align").find("i").html("format_align_left"),"right"==this.currTextStyle.align&&$("#btn_option_align").find("i").html("format_align_right"),"center"==this.currTextStyle.align&&$("#btn_option_align").find("i").html("format_align_center"),this.currTextStyle.fill?$("#btn_option_fill").find("i").html("font_download"):$("#btn_option_fill").find("i").html("format_color_text"),$(".focusing").css("font-family",this.currTextStyle.font),$(".focusing").css("font-size",this.currTextStyle.size),$(".focusing").css("text-align",this.currTextStyle.align),this.currTextStyle.fill?($(".focusing").css("color","white"),$(".focusing").css("background-color",this.currTextStyle.color)):($(".focusing").css("color",this.currTextStyle.color),$(".focusing").css("background-color","transparent")),$(".focusing").attr("styleText",JSON.stringify(this.currTextStyle).replaceAll('"',"'"))},addTouchTap:function(t,n){$(t).on("touchstart",function(t){1<t.touches.length||($(this).attr("downx",t.touches[0].clientX),$(this).attr("downy",t.touches[0].clientY),$(this).attr("movex",t.touches[0].clientX),$(this).attr("movey",t.touches[0].clientY),t.preventDefault())}),$(t).on("touchmove",function(t){1<t.touches.length||($(this).attr("movex",t.touches[0].clientX),$(this).attr("movey",t.touches[0].clientY))}),$(t).on("touchend",function(t){var e=parseInt($(this).attr("downx")),s=parseInt($(this).attr("downy")),o=parseInt($(this).attr("movex")),i=parseInt($(this).attr("movey"));Math.abs(e-o)<13&&Math.abs(s-i)<13&&n&&n(),t.preventDefault()}),$(t).on("mouseup",function(t){n&&n()})},updateMark:function(t){this.countWrong=$(".wrong").length,this.countRight=$(".correct").length,this.countWrong=this.countWrong<0?0:this.countWrong,this.countRight=this.countRight<0?0:this.countRight;var e,s,o=this.countRight+this.countWrong;(this.point=0)<o?(e=(10*this.countRight/o).toFixed(1),s=1==this.mnotedata.hideMark?"":" = "+e+" Điểm ",$("#mnote_mark_result").html("Trả lời đúng "+this.countRight+" / "+o+s+'.    <span style="color: green;margin-left: 20px;">đ : '+this.countRight+' </span> <span style="color: red;margin-left:20px ;">s : '+this.countWrong+"</span>"),this.point=null!=t&&null!=t?t:e):($("#mnote_mark_result").html("Chưa có số câu đúng , câu sai "),this.point=t),isNaN(this.point)&&(this.point=0),$("#mark_number_txt").val(this.point);var i=this;$(".btn-mark-chose-bt").each(function(){$(this).css("background-color","#e0e0e0"),$(this).find("span").css("color","#444444"),parseInt($(this).attr("data"))==Math.round(i.point)&&($(this).css("background-color","red"),$(this).find("span").css("color","white"))})},initMarkUI:function(){$(".mnote_mark_point_txt").focus(()=>{var t=$("#mnote_mark").get(0).getBoundingClientRect(),e=0;100<t.top&&(e=t.top-100),this.panzoom&&this.panzoom.moveBy(0,-e),this.markTxtFocus=!0,this.setMode(this.MODE_NORMAL)}),$(".mnote_mark_point_txt").blur(()=>{this.markTxtFocus=!1});var e=this;$("#mark_comment_txt").on("input",function(t){e.resizeTxtComment()});for(var t=10;0<=t;t--){var s=$('<div class="btn-mark-chose"><div data="'+t+'" class="btn-mark-chose-bt  btn-floating waves-effect waves-light" style="background-color:#e0e0e0"><span style="color:#444444">'+t+"</span></div></div>");$("#mnote_mark_chose").append($(s)),10==t&&$(s).find("span").css("left","30px")}$("#mnote_mark_chose").on("touchstart",t=>{t.preventDefault()}),$(".btn-mark-chose-bt").each(function(){e.addTouchTap($(this),()=>{e.updateMark(parseInt($(this).attr("data")))})}),$("#mnote_mark_hide").on("mouseup touchend",t=>{1==e.mnotedata.hideMark?e.showMark():e.hideMark(),e.updateMark(),t.preventDefault()});var o=$("#switch_hide_mark").find("input")[0];$(o).on("change",function(t){this.checked?e.showMark():e.hideMark(),t.stopPropagation(),t.preventDefault()}),$("#mark_number_txt").on("input",()=>{var t=Math.floor($("#mark_number_txt").val());isNaN(t)||$(".btn-mark-chose-bt").each(function(){$(this).css("background-color","#e0e0e0"),$(this).find("span").css("color","#444444"),parseInt($(this).attr("data"))==t&&($(this).css("background-color","red"),$(this).find("span").css("color","white"))})}),$("#mark_comment_txt").on("touchstart",t=>{}),$("#mnote_mark_emoji_bt").click(()=>{if("block"==$("#emoji_chosen").css("display"))$("#emoji_chosen").css("display","none");else if($("#emoji_chosen").css("display","block"),0==$(".emoji_chosen").length){for(var t=1;t<20;t++){var e=$("<img class='emoji_chosen' src='images/emoji/emoji"+t+".gif' width='80' height='80'/>");$("#emoji_chosen_container").append($(e)),$(e).css("cursor","pointer")}$("#emoji_chosen_container").width(80*(t+1)+"px");var s=this;$(".emoji_chosen").click(function(){s.addCommentEmoji([$(this).attr("src")])})}})},hideMark:function(t){if(this.mnotedata.hideMark=!0,$("#switch_hide_mark").find("input")[0].checked=!1,$("#mnote_mark_number").css("display","none"),$("#mnote_mark_comment").css("width","100%"),$("#mnote_mark_chose").css("display","none"),!t)try{localStorage.setItem("hideMark","true")}catch(t){}},showMark:function(t){if(this.mnotedata.hideMark=!1,$("#switch_hide_mark").find("input")[0].checked=!0,$("#mnote_mark_number").css("display","block"),$("#mnote_mark_comment").css("width","65%"),$("#mnote_mark_chose").css("display","block"),!t)try{localStorage.setItem("hideMark","false")}catch(t){}},resizeTxtComment:function(){var t=document.getElementById("mark_comment_txt"),t=$(t).height(),t=(t=t<200?200:t)+130+$("#mnote_mark_emoji").height();this.mnotedata&&"view"==this.mnotedata.mode&&(t+=80),$("#mnote_mark_point").css("height",t+"px"),$("#mark_number_txt").css("margin-top",(t-68-150)/2+"px");t=(t=$("#mnote_mark_emoji_container").height()-50)<0?0:t;$("#mnote_mark_emoji_bt").css("margin-top",t+"px")},addCommentEmoji:function(t){for(var e=0;e<t.length;e++){var s=$('<img class="comment_emoji" src="'+t[e]+'" width="120" height="120"/>');$("#mnote_mark_emoji_container").append($(s));var o=this;$(s).css("cursor","pointer"),$(s).click(function(t){"edit"==o.mnotedata.mode&&($(this).remove(),o.resizeTxtComment())})}this.resizeTxtComment()},initStaticTextSetting:function(){this.staticTextConfig={urlImgCorrect:"images/rightwrong/right1.png",urlImgWrong:"images/rightwrong/wrong1.png",textCorrect:"đ",textWrong:"s",useCorrectText:!0,useWrongText:!0,correctWidth:50,correctHeight:50,wrongWidth:50,wrongHeight:50,fontText:"font_chu_dep",fontSize:30,fontColor:"red"};try{var t=localStorage.getItem("staticTextConfig");t?this.staticTextConfig=JSON.parse(t):document.getElementById("ifclasslive").src="https://classlive.stume.net/localstorage.html"}catch(t){}$("#setting_static_text_size").on("input",()=>{$(".setting_text").css("font-size",$("#setting_static_text_size").val()+"px")}),$("#setting_static_text_font").on("change",()=>{$(".setting_text").css("font-family",$("#setting_static_text_font").val())}),$("#setting_static_text_close").click(()=>{this.hideStaticTextSetting()}),$("#static_text_txt_menu").click(()=>{$("#mnote_static_text_txt").css("display","block"),$("#mnote_static_text_img").css("display","none")}),$("#static_text_img_menu").click(()=>{$("#mnote_static_text_txt").css("display","none"),$("#mnote_static_text_img").css("display","block"),this.initStaticTextImageChosen()}),this.resizeTxtComment(),$("select").formSelect(),$("#setting_static_text_submit").click(()=>{var t=$("#setting_text_correct").html().trim();""==t&&(t="đ"),this.staticTextConfig.textCorrect=t,this.staticTextConfig.useCorrectText=!0;t=$("#setting_text_wrong").html().trim();""==t&&(t="s"),this.staticTextConfig.textWrong=t,this.staticTextConfig.useWrongText=!0,this.staticTextConfig.fontText=$("#setting_static_text_font").val(),this.staticTextConfig.fontSize=$("#setting_static_text_size").val(),this.staticTextConfig.correctWidth=$("#setting_text_correct").width(),this.staticTextConfig.correctHeight=$("#setting_text_correct").height(),this.staticTextConfig.wrongWidth=$("#setting_text_wrong").width(),this.staticTextConfig.wrongHeight=$("#setting_text_wrong").height(),$(".wrong").css("font-family",this.staticTextConfig.fontText),$(".wrong").css("font-size",this.staticTextConfig.fontSize),$(".wrong").find("span").html(this.staticTextConfig.textWrong),$(".correct").css("font-family",this.staticTextConfig.fontText),$(".correct").css("font-size",this.staticTextConfig.fontSize),$(".correct").find("span").html(this.staticTextConfig.textCorrect),$(".wrong").find("span").css("display","block"),$(".wrong").find("img").css("display","none"),$(".correct").find("span").css("display","block"),$(".correct").find("img").css("display","none");try{localStorage.setItem("staticTextConfig",JSON.stringify(this.staticTextConfig))}catch(t){}this.hideStaticTextSetting()}),$("#setting_static_img_submit").click(()=>{this.staticTextConfig.useCorrectText=!1,this.staticTextConfig.useWrongText=!1,this.staticTextConfig.correctWidth=50,this.staticTextConfig.correctHeight=50,this.staticTextConfig.wrongWidth=50,this.staticTextConfig.wrongHeight=50,this.staticTextConfig.urlImgCorrect=$("#static_img_corect").attr("src"),this.staticTextConfig.urlImgWrong=$("#static_img_wrong").attr("src"),$(".correct_img").attr("src",this.staticTextConfig.urlImgCorrect),$(".wrong_img").attr("src",this.staticTextConfig.urlImgWrong),$(".wrong").find("span").css("display","none"),$(".wrong").find("img").css("display","block"),$(".correct").find("span").css("display","none"),$(".correct").find("img").css("display","block");try{localStorage.setItem("staticTextConfig",JSON.stringify(this.staticTextConfig))}catch(t){}this.hideStaticTextSetting()})},showStaticTextSetting:function(){$("#setting_static_text").css("display","block"),$("#setting_text_correct").html(this.staticTextConfig.textCorrect),$("#setting_text_wrong").html(this.staticTextConfig.textWrong),$(".setting_text").css("font-size",this.staticTextConfig.fontSize+"px"),$(".setting_text").css("font-family",this.staticTextConfig.fontText),$("#setting_static_text_size").val(this.staticTextConfig.fontSize),$("#setting_static_text_font").val(this.staticTextConfig.fontText),$("select").formSelect(),""==this.staticTextConfig.urlImgCorrect&&(this.staticTextConfig.urlImgCorrect="images/rightwrong/right1.png"),""==this.staticTextConfig.urlImgWrong&&(this.staticTextConfig.urlImgWrong="images/rightwrong/wrong1.png"),$("#static_img_corect").attr("src",this.staticTextConfig.urlImgCorrect),$("#static_img_wrong").attr("src",this.staticTextConfig.urlImgWrong),this.staticTextConfig.useCorrectText?($("#mnote_static_text_txt").css("display","block"),$("#mnote_static_text_img").css("display","none")):($("#mnote_static_text_txt").css("display","none"),$("#mnote_static_text_img").css("display","block"),this.initStaticTextImageChosen())},hideStaticTextSetting:function(){$("#setting_static_text").css("display","none")},initStaticTextImageChosen:function(){if(0==$(".static_img_correct").length){for(var t=1;t<6;t++){var e=$("<img class='static_img_correct' src='images/rightwrong/right"+t+".png' width='30' height='30'/>");$("#static_img_corect_container").append($(e));e=$("<img class='static_img_wrong' src='images/rightwrong/wrong"+t+".png' width='30' height='30'/>");$("#static_img_wrong_container").append($(e))}$(".static_img_correct").click(function(){$("#static_img_corect").attr("src",$(this).attr("src"))}),$(".static_img_wrong").click(function(){$("#static_img_wrong").attr("src",$(this).attr("src"))})}},initMathEditor:function(){is_touch_device()&&($("#math_editor").css("height",window.innerHeight-60),$("#math_editor").css("top","60")),$("#math_editor_close").click(()=>{this.hideMathEditor()}),$("#math_editor_submit").click(()=>{}),this.myEditor=new MathEditor("mathquill_editor"),this.myEditor.styleMe({textarea_background:"#FFFFFF",textarea_foreground:"#FF0000",textarea_border:"#000000",toolbar_background:"#FFFFFF",toolbar_foreground:"#000000",toolbar_border:"#000000",button_background:"#FFFFFF",button_border:"#000000"})},showMathEditor:function(){$("#math_editor").css("display","block"),this.myEditor.setLatex("")},hideMathEditor:function(){$("#math_editor").css("display","none")},convertCoordGlobalToLocal:function(t,e){var s={x:t,y:e};s.x=t*this.pageScale,s.y=e*this.pageScale;e=0;return is_touch_device()||(e=document.getElementById("mnote_content").scrollTop),s.y+=e,s},exportPdf:function(){showLoading(),this.zipExport=new JSZip,$(".bt-edit-bg").css("display","none"),setTimeout(()=>{this.exportPdfPage(0)},300)},exportPdfPage:function(e){e<0&&(e=0),e>=this.pageCount?html2canvas(document.querySelector("#mnote_mark_point"),{useCORS:!0}).then(t=>{t=(t=t.toDataURL("image/jpeg",70)).substr(23);this.zipExport.file("diem_loiphe.jpg",t,{base64:!0});var e=this.mnotedata.classname+"_"+this.mnotedata.fullname+"_"+this.mnotedata.homeworkTime+"_"+this.mnotedata.homework;this.zipExport.generateAsync({type:"blob"}).then(function(t){hideLoading(),$(".bt-edit-bg").css("display","block"),saveAs(t,e+".zip")})}):html2canvas(document.querySelector("#page_"+e),{useCORS:!0}).then(t=>{t=(t=t.toDataURL("image/jpeg",70)).substr(23);this.zipExport.file("trang_"+e+".jpg",t,{base64:!0}),this.exportPdfPage(e+1)})},exportPdf_:function(){showLoading(),$("#mnote_mark_chose").css("display","none"),$("#btn_save_data").css("display","none"),$("#mnote_hold_bt").css("display","none"),$("#mnote_setting_bt").css("display","none"),$("#hide_mark").css("display","none");var s=$("#mnote_mark").css("top");$("#mnote_mark").css("top","36px"),$("#mnote_mark_hide").css("display","none");var t=$("#mnote_mark_point").height()+20;$("#mnote_pages").css("padding-top",t+"px");t=$("#mnote_user_info").height()-10;$("#mnote_pages").css("margin-top",t+"px"),$("#mnote_mark_result").css("display","none"),$("#mnote_mark_emoji_bt").css("display","none"),$("#mnote_help").css("display","none"),$("#mnote_mark_emoji_bt").css("display","none"),$("#mnote_user_info").css("display","block"),$(".bt-edit-bg").css("display","none"),$("#emoji_chosen").css("display","none");var o=this.mnotedata.classname+"_"+this.mnotedata.fullname+"_"+this.mnotedata.homeworkTime+"_"+this.mnotedata.homework;setTimeout(()=>{html2canvas(document.querySelector("#mnote_container"),{useCORS:!0}).then(t=>{var e=document.createElement("a");e.download=o+".jpg",e.href=t.toDataURL("image/jpeg",.9),e.click(),$("#mnote_mark_chose").css("display","block"),$("#btn_save_data").css("display","block"),$("#mnote_hold_bt").css("display","block"),$("#mnote_setting_bt").css("display","block"),$("#hide_mark").css("display","flex"),$("#mnote_mark").css("top",s),$("#mnote_mark_hide").css("display","block"),$("#mnote_pages").css("padding-top","0px"),$("#mnote_pages").css("margin-top","0px"),$("#mnote_mark_result").css("display","flex"),$("#mnote_mark_emoji_bt").css("display","block"),$("#mnote_help").css("display","block"),$("#mnote_mark_emoji_bt").css("display","block"),$("#mnote_user_info").css("display","none"),$(".bt-edit-bg").css("display","block"),hideLoading()})},1e3)},isPanzoomEnable:function(){return(this.mode!=this.MODE_DRAWRING||this.currBrush!=this.BRUSH_PEN&&this.currBrush!=this.BRUSH_ERASE&&this.currBrush!=this.BRUSH_LINE&&this.currBrush!=this.BRUSH_RECTANGLE&&this.currBrush!=this.BRUSH_CIRCLE&&this.currBrush!=this.BRUSH_ARROW)&&(this.mode!=this.MODE_ENTER_TEXT&&1!=this.markTxtFocus)},onresize:function(t,e){is_touch_device()&&(this.appWidth==t&&this.appHeight,this.appWidth==t&&this.appHeight<e&&(this.blurText(),$(".mnote_mark_point_txt").blur())),this.appWidth=t,this.appHeight=e,$("#mnote_app").css("height",e+"px"),$(this.note_content).css("height",e+"px"),$(this.note_pages).width(this.pageWidth),this.pageScale=$(this.note_content).width()/this.pageWidth,$(this.note_pages).css("transform","scale("+this.pageScale+")")}}),MNote=function(){var t;return{getInstance:function(){return t=t||new MNote_instance},releaseInst:function(){t=null},inst:function(){return this.getInstance()}}}();function loadCss(){var t=document.getElementsByTagName("head")[0],e=(document.body,document.createElement("link")),s=(document.createElement("img"),"css/mnote_u.css?t="+(new Date).getTime());e.href=s,e.rel="stylesheet",t.appendChild(e),startApp()}function startApp(){$("#root").css("display","block"),mnote=MNote.getInstance()}loadCss();